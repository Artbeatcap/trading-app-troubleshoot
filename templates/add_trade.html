{% extends "base.html" %}

{% block title %}Add Trade - Options Plunge{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus text-primary me-2"></i>
        Add New Trade
    </h1>
    <p class="text-muted mb-3 text-center">
        <i class="fas fa-info-circle me-2"></i>
        Use this page to journal your existing or potential trades. Once the trades are saved, you can use the AI analysis to review the trade.
    </p>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('trades') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Trades
        </a>
    </div>
</div>

<!-- Symbol Input Section - SINGLE SOURCE OF TRUTH -->
<div class="card mb-3" style="position: relative; z-index: 1000;">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label for="symbol-input" class="form-label fw-bold">
                    <i class="fas fa-tag me-2"></i>Stock Symbol
                </label>
                <input type="text" class="form-control form-control-lg" id="symbol-input" name="symbol" 
                       placeholder="Enter symbol (e.g., AAPL)" autocomplete="off" required>
                <small class="text-muted">This symbol will be used for the chart and trade details</small>
            </div>
            <div class="col-md-8">
                <div class="autocomplete-results" id="symbol-autocomplete"></div>
            </div>
        </div>
    </div>
</div>

<!-- Chart & Levels Card - MOVED TO TOP -->
<div class="card mb-4" style="position: relative; z-index: 1;">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Chart & Levels</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Timeframe</label>
                <select id="chart-timeframe" class="form-select">
                    <option value="1d">Daily</option>
                    <option value="4h">4 hour</option>
                    <option value="1h">Hourly</option>
                    <option value="5m">5 min</option>
                    <option value="1m">1 min</option>
                </select>
            </div>
            <div class="col-md-8">
                <button id="load-chart" type="button" class="btn btn-outline-primary me-2">
                    <i class="fas fa-sync-alt me-1"></i>Load Chart
                </button>
                <button id="auto-levels" type="button" class="btn btn-outline-success me-2">
                    <i class="fas fa-magic me-1"></i>Auto-mark S/R
                </button>
                <button id="explain-btn" type="button" class="btn btn-outline-info me-2">
                    <i class="fas fa-robot me-1"></i>Explain this chart
                </button>
                <button id="save-snapshot" type="button" class="btn btn-primary">
                    <i class="fas fa-camera me-1"></i>Save Snapshot to Trade
                </button>
            </div>
        </div>
        
        <!-- Enhanced S/R Controls -->
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="major-only" checked>
                        <label class="form-check-label" for="major-only">Major only</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="show-circles" checked>
                        <label class="form-check-label" for="show-circles">Show pivots</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <select id="level-style" class="form-select form-select-sm" style="width: auto;">
                            <option value="zone" selected>Zones</option>
                            <option value="line">Lines</option>
                        </select>
                    </div>
                    <div class="form-check form-check-inline">
                        <select id="max-levels" class="form-select form-select-sm" style="width: auto;">
                            <option>3</option><option selected>4</option><option>5</option>
                        </select>
                    </div>
                    <button id="clear-levels" type="button" class="btn btn-outline-secondary btn-sm">
                        Clear
                    </button>
                    <small class="text-muted ms-2">Intraday covers recent history; older data auto-switches to Daily.</small>
                </div>
            </div>
        </div>
        
        <!-- Extended Hours Controls -->
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="include-premarket" checked>
                        <label class="form-check-label" for="include-premarket">Pre-market</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="include-afterhours" checked>
                        <label class="form-check-label" for="include-afterhours">After-hours</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="hide-closed" checked>
                        <label class="form-check-label" for="hide-closed">Hide closed sessions</label>
                    </div>
                    <small class="text-muted ms-2">Pre-market: 4:00-9:30 ET | After-hours: 16:00-20:00 ET</small>
                </div>
            </div>
        </div>

        <!-- Scroll Zoom Tip -->
        <div class="row mt-1">
            <div class="col-md-12">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    üí° Tip: Scroll on chart to zoom price (Y-axis), Shift+Scroll to zoom time (X-axis)
                </small>
            </div>
        </div>

        <!-- Zoom/Pan/Draw Controls -->
        <div class="d-flex flex-wrap gap-2 mb-2">
            <!-- Zoom range presets -->
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-zoom="1D">1D</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="5D">5D</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="1M">1M</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="3M">3M</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="6M">6M</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="YTD">YTD</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="1Y">1Y</button>
                <button class="btn btn-sm btn-outline-primary" data-zoom="ALL">All</button>
            </div>

            <!-- Pan/Zoom controls -->
            <div class="btn-group ms-2">
                <button class="btn btn-sm btn-outline-secondary" id="zoom-in">Ôºã</button>
                <button class="btn btn-sm btn-outline-secondary" id="zoom-out">Ôºç</button>
                <button class="btn btn-sm btn-outline-secondary" id="pan-left">‚üµ</button>
                <button class="btn btn-sm btn-outline-secondary" id="pan-right">‚ü∂</button>
                <button class="btn btn-sm btn-outline-secondary" id="reset">Reset</button>
            </div>

            <!-- Draw tools -->
            <div class="btn-group ms-2">
                <button class="btn btn-sm btn-outline-success" data-draw="zoom">Zoom</button>
                <button class="btn btn-sm btn-outline-success" data-draw="pan">Pan</button>
                <button class="btn btn-sm btn-outline-success" data-draw="line">Line</button>
                <button class="btn btn-sm btn-outline-success" data-draw="rect">Zone</button>
                <button class="btn btn-sm btn-outline-danger"  data-draw="erase">Erase</button>
            </div>
        </div>

        <div id="tradeChart" style="height: 460px;" class="mt-3"></div>
        
        <!-- Level Legend -->
        <div id="level-legend" class="mt-2"></div>
        <div id="explain-result" class="mt-3"></div>
        
        <style>
        #level-legend .badge { margin-right: .4rem; margin-bottom: .35rem; font-weight: 500; }
        #level-legend .legend-title { font-size: .9rem; color: #6c757d; margin-right: .5rem; }
        .js-plotly-plot .modebar-btn svg { width: 20px; height: 20px; }
        .js-plotly-plot .modebar-group .modebar-btn { padding: 6px; }
        .xaxislayer-above:hover,
        .yaxislayer-above:hover,
        .xtick:hover,
        .ytick:hover {
            cursor: ns-resize !important; /* vertical resize cursor for zoom indication */
        }
        .nsewdrag:hover,
        .xy:hover,
        .plot:hover {
            cursor: move !important; /* indicate chart is interactive */
        }
        </style>

        <!-- Hidden fields to submit with the trade -->
        <input type="hidden" name="chart_annotations_json" id="chart_annotations_json">
        <input type="hidden" name="chart_snapshot_path" id="chart_snapshot_path">
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Trade Details
                </h5>
            </div>
            <div class="card-body">
                <!-- Planned Trade Option -->
                <div class="mb-4">
                    <div class="form-check">
                        {{ form.is_planned(class="form-check-input", id="is_planned") }}
                        {{ form.is_planned.label(class="form-check-label", for="is_planned") }}
                        <small class="form-text text-muted">
                            Check this if you're planning a trade but haven't entered it yet. Entry price, quantity, and date will be optional.
                        </small>
                    </div>
                </div>
                {% if not current_user.is_authenticated %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    You can fill out the trade details now. Your information will be saved temporarily and can be permanently saved after you log in or create an account.
                </div>
                {% endif %}
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <!-- Hidden field - value comes from top symbol input -->
                    <input type="hidden" name="symbol" id="symbol-hidden">
                    
                    <!-- Basic Trade Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.trade_type.label(class="form-label fw-bold") }}
                                {{ form.trade_type(class="form-select", id="trade_type") }}
                                {% if form.trade_type.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.trade_type.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options-specific fields (hidden by default) -->
                    <div id="options-fields" style="display: none;">
                        <h6 class="text-info mb-3">
                            <i class="fas fa-certificate me-2"></i>
                            Options Details
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.strike_price.label(class="form-label") }}
                                    {{ form.strike_price(class="form-control") }}
                                    {% if form.strike_price.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.strike_price.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.expiration_date.label(class="form-label") }}
                                    {{ form.expiration_date(class="form-control") }}
                                    {% if form.expiration_date.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.expiration_date.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Underlying Stock Prices -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.underlying_price_at_entry.label(class="form-label") }}
                                    {{ form.underlying_price_at_entry(class="form-control") }}
                                    {% if form.underlying_price_at_entry.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.underlying_price_at_entry.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.underlying_price_at_exit.label(class="form-label") }}
                                    {{ form.underlying_price_at_exit(class="form-control") }}
                                    {% if form.underlying_price_at_exit.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.underlying_price_at_exit.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Spread-specific fields (hidden by default) -->
                    <div id="spread-fields" style="display: none;">
                        <h6 class="text-warning mb-3">
                            <i class="fas fa-arrows-alt-h me-2"></i>
                            Credit Spread Details
                        </h6>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.short_strike.label(class="form-label") }}
                                    {{ form.short_strike(class="form-control") }}
                                    <small class="text-muted">Strike price of the option you sell</small>
                                    {% if form.short_strike.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.short_strike.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.long_strike.label(class="form-label") }}
                                    {{ form.long_strike(class="form-control") }}
                                    <small class="text-muted">Strike price of the option you buy (protection)</small>
                                    {% if form.long_strike.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.long_strike.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.short_premium.label(class="form-label") }}
                                    {{ form.short_premium(class="form-control") }}
                                    <small class="text-muted">Premium received for short leg</small>
                                    {% if form.short_premium.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.short_premium.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.long_premium.label(class="form-label") }}
                                    {{ form.long_premium(class="form-control") }}
                                    <small class="text-muted">Premium paid for long leg</small>
                                    {% if form.long_premium.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.long_premium.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.net_credit.label(class="form-label") }}
                                    {{ form.net_credit(class="form-control") }}
                                    <small class="text-muted">Net credit received</small>
                                    {% if form.net_credit.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.net_credit.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entry Information -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Entry Information <span id="entry-optional-text" class="text-muted" style="display: none;">(Optional for planned trades)</span>
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.entry_date.label(class="form-label") }}
                                {{ form.entry_date(class="form-control", id="entry_date", placeholder="YYYY-MM-DD HH:MM") }}
                                <small class="form-text text-muted">Pick the date & time or type YYYY-MM-DD HH:MM.</small>
                                <div class="btn-group btn-group-sm mt-2" role="group" aria-label="Entry quick times">
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#entry_date" data-dt="now">Now</button>
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#entry_date" data-dt="open">Open</button>
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#entry_date" data-dt="close">Close</button>
                                </div>
                                {% if form.entry_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.entry_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label" id="entry-price-label">Entry Price ($)</label>
                                {{ form.entry_price(class="form-control", inputmode="decimal", step="0.01") }}
                                <small class="text-muted" id="entry-price-help">Price per share/contract</small>
                                {% if form.entry_price.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.entry_price.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label" id="quantity-label">Quantity</label>
                                {{ form.quantity(class="form-control") }}
                                <small class="text-muted" id="quantity-help">Number of shares/contracts</small>
                                {% if form.quantity.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Management -->
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-shield-alt me-2"></i>
                        Risk Management
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.stop_loss.label(class="form-label") }}
                                {{ form.stop_loss(class="form-control") }}
                                {% if form.stop_loss.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.stop_loss.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.take_profit.label(class="form-label") }}
                                {{ form.take_profit(class="form-control") }}
                                {% if form.take_profit.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.take_profit.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.risk_amount.label(class="form-label") }}
                                {{ form.risk_amount(class="form-control") }}
                                {% if form.risk_amount.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.risk_amount.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exit Information -->
                    <h6 class="text-success mb-3">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        Exit Information <small class="text-muted">(Optional - leave blank for open trades)</small>
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.exit_date.label(class="form-label") }}
                                {{ form.exit_date(class="form-control", id="exit_date", placeholder="YYYY-MM-DD HH:MM") }}
                                <small class="form-text text-muted">Optional; leave blank if the trade is still open.</small>
                                <div class="btn-group btn-group-sm mt-2" role="group" aria-label="Exit quick times">
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#exit_date" data-dt="now">Now</button>
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#exit_date" data-dt="open">Open</button>
                                    <button type="button" class="btn btn-outline-secondary" data-dt-target="#exit_date" data-dt="close">Close</button>
                                </div>
                                {% if form.exit_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.exit_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.exit_price.label(class="form-label") }}
                                {{ form.exit_price(class="form-control", inputmode="decimal", step="0.01") }}
                                {% if form.exit_price.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.exit_price.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade Context -->
                    <h6 class="text-info mb-3">
                        <i class="fas fa-chart-bar me-2"></i>
                        Trade Context
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.setup_type.label(class="form-label") }}
                                {{ form.setup_type(class="form-select") }}
                                {% if form.setup_type.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.setup_type.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.market_condition.label(class="form-label") }}
                                {{ form.market_condition(class="form-select") }}
                                {% if form.market_condition.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.market_condition.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.timeframe.label(class="form-label") }}
                                {{ form.timeframe(class="form-select") }}
                                {% if form.timeframe.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.timeframe.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reasoning and Notes -->
                    <h6 class="text-secondary mb-3">
                        <i class="fas fa-comment me-2"></i>
                        Your Analysis & Notes
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.entry_reason.label(class="form-label") }}
                                {{ form.entry_reason(class="form-control") }}
                                {% if form.entry_reason.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.entry_reason.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.exit_reason.label(class="form-label") }}
                                {{ form.exit_reason(class="form-control") }}
                                {% if form.exit_reason.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.exit_reason.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="mb-3">
                                {{ form.notes.label(class="form-label") }}
                                {{ form.notes(class="form-control") }}
                                {% if form.notes.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.notes.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.tags.label(class="form-label") }}
                                {{ form.tags(class="form-control") }}
                                {% if form.tags.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.tags.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label fw-semibold">Quick Journal (optional)</label>
                        <input type="hidden" name="journal_meta" id="journal_meta">
                        <div class="d-flex flex-wrap gap-2 mb-2" id="journal_tags">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tag="Followed plan">Followed plan</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tag="Chased entry">Chased entry</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tag="FOMO">FOMO</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tag="News catalyst">News catalyst</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tag="Broke rules">Broke rules</button>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-8">
                                <input class="form-control" id="journal_note" placeholder="1‚Äì2 lines: setup, reason, lesson">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small mb-1">Confidence</label>
                                <input type="range" class="form-range" id="journal_conf" min="1" max="5" value="3">
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Charts & Screenshots -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Charts & Screenshots</label>
                        <div id="op-drop" class="border border-2 border-dashed rounded-3 p-4 text-center bg-light" style="cursor: pointer;">
                            <div class="mb-1">Drag & drop images here</div>
                            <div class="text-muted small">‚Ä¶or click to browse / paste from clipboard</div>
                            <input id="op-files" name="screenshots" type="file" accept="image/*" multiple hidden>
                        </div>
                        <div id="op-preview" class="d-flex flex-wrap gap-3 mt-3"></div>
                        <div class="form-text">PNG, JPG, GIF ‚Äî up to 10 files, 10 MB each.</div>
                    </div>

                    <!-- Chart Screenshots -->
                    <h6 class="text-purple mb-3">
                        <i class="fas fa-camera me-2"></i>
                        Chart Screenshots <span class="badge bg-info">Enhanced AI Analysis</span>
                    </h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.entry_chart_image.label(class="form-label") }}
                                {{ form.entry_chart_image(class="form-control") }}
                                {% if form.entry_chart_image.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.entry_chart_image.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="text-muted">Upload a screenshot of your chart at entry time</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.exit_chart_image.label(class="form-label") }}
                                {{ form.exit_chart_image(class="form-control") }}
                                {% if form.exit_chart_image.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.exit_chart_image.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="text-muted">Upload a screenshot of your chart at exit time</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="submit" class="btn btn-primary" name="next_action" value="save" id="save-btn">Save</button>
                        <button type="submit" class="btn btn-outline-primary" name="next_action" value="save_add">Save & Add Another</button>
                        <button type="submit" class="btn btn-outline-secondary" name="next_action" value="save_dup">Save & Duplicate</button>
                        
                        <!-- Planned trade buttons (hidden by default) -->
                        <button type="submit" class="btn btn-success" name="next_action" value="save_planned" id="save-planned-btn" style="display: none;">
                            <i class="fas fa-save me-1"></i>Save Planned
                        </button>
                        <button type="submit" class="btn btn-warning" name="next_action" value="save_planned_analyze" id="save-planned-analyze-btn" style="display: none;">
                            <i class="fas fa-brain me-1"></i>Save & Analyze Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar with Tips -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    Trade Journal Tips
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-primary">üìä Setup Types</h6>
                    <small class="text-muted">
                        Choose the pattern or setup that prompted your trade:
                        breakout, pullback, reversal, support/resistance, etc.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-warning">üõ°Ô∏è Risk Management</h6>
                    <small class="text-muted">
                        Always set stop losses and consider your risk/reward ratio. 
                        A good rule is to risk no more than 2% of your account per trade.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-success">üìù Documentation</h6>
                    <small class="text-muted">
                        The more detail you provide about your reasoning, 
                        the better the AI can analyze and help improve your trading.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-info">ü§ñ AI Analysis</h6>
                    <small class="text-muted">
                        Upload chart screenshots for enhanced AI analysis! The AI will analyze 
                        your charts to provide detailed technical feedback on entry/exit timing, 
                        support/resistance levels, and pattern recognition.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-purple">üì∏ Chart Screenshots</h6>
                    <small class="text-muted">
                        For best results, upload clear screenshots showing key levels, 
                        indicators, and the timeframe you used for your trade decisions.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-info">üìã Options Trading</h6>
                    <small class="text-muted">
                        For options trades, include strike price, expiration, and underlying stock price. 
                        Greeks and implied volatility help the AI provide better analysis of your options strategy.
                    </small>
                </div>
                
                <div class="mb-0">
                    <h6 class="text-warning">‚è∞ Time Decay</h6>
                    <small class="text-muted">
                        Options lose value over time (theta decay). Consider how much time 
                        you have until expiration and how it affects your strategy.
                    </small>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-success">üí∞ Credit Spreads</h6>
                    <small class="text-muted">
                        Credit spreads collect premium upfront. For put spreads: sell higher strike, buy lower strike. 
                        For call spreads: sell lower strike, buy higher strike. Max profit = net credit received.
                    </small>
                </div>
                
                <div class="mb-0">
                    <h6 class="text-primary">üìê Strike Selection</h6>
                    <small class="text-muted">
                        Choose strikes based on your market outlook and risk tolerance. 
                        Wider spreads = more credit but higher risk. Closer to money = more credit but lower probability.
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Quick Reference -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-clock text-info me-2"></i>
                    Quick Reference
                </h6>
            </div>
            <div class="card-body">
                <small>
                    <strong>Date Format:</strong> YYYY-MM-DD HH:MM<br>
                    <strong>Price Format:</strong> Decimal (e.g., 150.25)<br>
                    <strong>Tags:</strong> Comma-separated (momentum, earnings)<br>
                    <strong>Open Trades:</strong> Leave exit fields blank
                </small>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
(function () {
    function initPicker(sel, opts) {
        var el = document.querySelector(sel);
        if (!el) return;
        if (el.dataset.pickerInit === '1') return; // idempotent
        flatpickr(el, Object.assign({
            enableTime: true,
            dateFormat: "Y-m-d H:i",   // keeps backend format: YYYY-MM-DD HH:MM
            time_24hr: true,
            minuteIncrement: 5
        }, opts || {}));
        el.dataset.pickerInit = '1';
    }
    document.addEventListener('DOMContentLoaded', function () {
        initPicker('#entry_date', { defaultDate: new Date() });
        initPicker('#exit_date');
    });
})();
</script>
<script>
// Auto-run Explain if deep link parameter present: ?auto_explain=1&symbol=NVDA
document.addEventListener('DOMContentLoaded', ()=>{
    try{
        const usp = new URLSearchParams(window.location.search);
        if(usp.get('symbol')){
            const s = usp.get('symbol').toUpperCase();
            const el = document.getElementById('symbol-input');
            if(el) el.value = s;
        }
        if(usp.get('auto_explain')==='1'){
            const loadBtn = document.getElementById('load-chart');
            if(loadBtn) loadBtn.click();
            setTimeout(()=>{ document.getElementById('explain-btn')?.click(); }, 500);
        }
    }catch(_){ }
});
</script>
<script>
(function(){
    const dz = document.getElementById('op-drop');
    const input = document.getElementById('op-files');
    const preview = document.getElementById('op-preview');
    if(!dz || !input || !preview) return;

    const MAX_FILES = 10;
    const MAX_MB = 10;
    const filesState = [];

    dz.addEventListener('click', () => input.click());
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dz.classList.add('border-primary','bg-white','shadow-sm');
    }));
    ['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dz.classList.remove('border-primary','bg-white','shadow-sm');
    }));

    input.addEventListener('change', () => handleFiles(input.files));
    dz.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
    document.addEventListener('paste', (e)=>{
        if (!document.activeElement || document.activeElement.tagName.toLowerCase() === 'input') return;
        if (e.clipboardData && e.clipboardData.files?.length) handleFiles(e.clipboardData.files);
    });

    function handleFiles(list){
        const incoming = Array.from(list || []);
        for(const f of incoming){
            if(!f.type.startsWith('image/')) continue;
            if(f.size > MAX_MB*1024*1024){ toast('Too large: '+ f.name); continue; }
            if(filesState.length >= MAX_FILES){ toast('Max '+MAX_FILES+' images.'); break; }
            filesState.push(f);
        }
        syncInput(); render();
    }

    function syncInput(){
        const dt = new DataTransfer();
        filesState.forEach(f => dt.items.add(f));
        input.files = dt.files;
    }

    function render(){
        preview.innerHTML = '';
        filesState.forEach((file, idx)=>{
            const url = URL.createObjectURL(file);
            const card = document.createElement('div');
            card.className = 'card shadow-sm'; card.style.width='140px';
            card.innerHTML = `
                <img src="${url}" class="card-img-top" style="height:100px;object-fit:cover" alt="">
                <div class="card-body p-2">
                  <div class="small text-truncate" title="${file.name}">${file.name}</div>
                  <div class="text-muted small">${(file.size/1024/1024).toFixed(1)} MB</div>
                  <button type="button" class="btn btn-sm btn-outline-danger w-100 mt-2" data-remove="${idx}">Remove</button>
                </div>`;
            preview.appendChild(card);
        });
    }

    preview.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-remove]');
        if(!btn) return;
        const i = +btn.getAttribute('data-remove');
        filesState.splice(i,1);
        syncInput(); render();
    });

    function toast(msg){
        const el = document.createElement('div');
        el.className='position-fixed top-0 start-50 translate-middle-x alert alert-warning shadow';
        el.style.zIndex=1080; el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 2200);
    }
})();
</script>
<script>
// Quick-pick times (local): Now/Open/Close
function setQuickDT(targetSel, mode){
    const el = document.querySelector(targetSel);
    if(!el) return;
    const d = new Date();
    if(mode === 'open'){ d.setHours(9,30,0,0); }
    else if(mode === 'close'){ d.setHours(16,0,0,0); }
    const pad = n => String(n).padStart(2,'0');
    const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    if(el.type === 'datetime-local'){ el.value = local; }
    else { el.value = local.replace('T',' '); }
}
document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-dt]');
    if(!btn) return;
    setQuickDT(btn.getAttribute('data-dt-target'), btn.getAttribute('data-dt'));
});
</script>
<script>
// Uppercase & trim for symbol input
document.addEventListener('input', e=>{
    if(e.target && e.target.id === 'symbol-input'){
        const caret = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase().replace(/\s+/g,'');
        if(typeof caret === 'number') e.target.setSelectionRange(caret, caret);
    }
});
</script>
<script>
// Prevent accidental changes via mouse wheel on number-like fields
document.addEventListener('wheel', (e)=>{
    const t = e.target;
    if(t && (t.matches('input[type=number]') || t.getAttribute('inputmode') === 'decimal')) {
        t.blur();
    }
}, {passive:true});
</script>
<script>
// Autosave drafts and warn on unload
(function(){
    const form = document.querySelector('form');
    if(!form) return;
    const KEY = 'add_trade_draft_v1';
    try{
        const raw = localStorage.getItem(KEY);
        if(raw){
            const data = JSON.parse(raw);
            for(const [k,v] of Object.entries(data)){
                const el = form.elements.namedItem(k);
                if(el && !el.value) el.value = v;
            }
        }
    }catch(_){ }
    const save = () => {
        const data = {};
        Array.from(form.elements).forEach(el=>{
            if(!el.name) return;
            if(['submit','button'].includes(el.type)) return;
            data[el.name] = el.value;
        });
        localStorage.setItem(KEY, JSON.stringify(data));
    };
    form.addEventListener('input', save);
    form.addEventListener('change', save);
    form.addEventListener('submit', ()=> localStorage.removeItem(KEY));
    let cleanSnapshot = localStorage.getItem(KEY);
    window.addEventListener('beforeunload', (e)=>{
        if(localStorage.getItem(KEY) !== cleanSnapshot){
            e.preventDefault(); e.returnValue = '';
        }
    });
})();
</script>
<script>
// Inline journal serialization
(function(){
    const tagsEl = document.getElementById('journal_tags');
    const noteEl = document.getElementById('journal_note');
    const confEl = document.getElementById('journal_conf');
    const outEl  = document.getElementById('journal_meta');
    if(!tagsEl || !noteEl || !confEl || !outEl) return;
    const tags = new Set();
    tagsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-tag]');
        if(!btn) return;
        const t = btn.getAttribute('data-tag');
        if(tags.has(t)){ tags.delete(t); btn.classList.remove('btn-secondary'); btn.classList.add('btn-outline-secondary'); }
        else { tags.add(t); btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-secondary'); }
        serialize();
    });
    [noteEl, confEl].forEach(el=> el.addEventListener('input', serialize));
    function serialize(){
        outEl.value = JSON.stringify({ tags:[...tags], note: noteEl.value || null, confidence: Number(confEl.value) });
    }
    serialize();
})();
</script>
<script>
// Comprehensive list of 500+ popular stocks with options (same as options calculator)
const POPULAR_STOCKS = [
    {symbol: 'AAPL', name: 'Apple Inc'},
    {symbol: 'MSFT', name: 'Microsoft Corporation'},
    {symbol: 'GOOGL', name: 'Alphabet Inc Class A'},
    {symbol: 'AMZN', name: 'Amazon.com Inc'},
    {symbol: 'TSLA', name: 'Tesla Inc'},
    {symbol: 'NVDA', name: 'NVIDIA Corporation'},
    {symbol: 'META', name: 'Meta Platforms Inc'},
    {symbol: 'BRK.B', name: 'Berkshire Hathaway Inc Class B'},
    {symbol: 'LLY', name: 'Eli Lilly and Company'},
    {symbol: 'V', name: 'Visa Inc'},
    {symbol: 'UNH', name: 'UnitedHealth Group Inc'},
    {symbol: 'JPM', name: 'JPMorgan Chase & Co'},
    {symbol: 'XOM', name: 'Exxon Mobil Corporation'},
    {symbol: 'MA', name: 'Mastercard Inc'},
    {symbol: 'PG', name: 'Procter & Gamble Company'},
    {symbol: 'JNJ', name: 'Johnson & Johnson'},
    {symbol: 'HD', name: 'Home Depot Inc'},
    {symbol: 'CVX', name: 'Chevron Corporation'},
    {symbol: 'MRK', name: 'Merck & Co Inc'},
    {symbol: 'ABBV', name: 'AbbVie Inc'},
    {symbol: 'BAC', name: 'Bank of America Corp'},
    {symbol: 'KO', name: 'Coca-Cola Company'},
    {symbol: 'AVGO', name: 'Broadcom Inc'},
    {symbol: 'WMT', name: 'Walmart Inc'},
    {symbol: 'ORCL', name: 'Oracle Corporation'},
    {symbol: 'COST', name: 'Costco Wholesale Corp'},
    {symbol: 'PEP', name: 'PepsiCo Inc'},
    {symbol: 'ADBE', name: 'Adobe Inc'},
    {symbol: 'TMO', name: 'Thermo Fisher Scientific'},
    {symbol: 'MCD', name: 'McDonald\'s Corporation'},
    {symbol: 'ACN', name: 'Accenture plc'},
    {symbol: 'CSCO', name: 'Cisco Systems Inc'},
    {symbol: 'ABT', name: 'Abbott Laboratories'},
    {symbol: 'CRM', name: 'Salesforce Inc'},
    {symbol: 'NFLX', name: 'Netflix Inc'},
    {symbol: 'WFC', name: 'Wells Fargo & Company'},
    {symbol: 'DHR', name: 'Danaher Corporation'},
    {symbol: 'INTU', name: 'Intuit Inc'},
    {symbol: 'VZ', name: 'Verizon Communications'},
    {symbol: 'PM', name: 'Philip Morris International'},
    {symbol: 'TXN', name: 'Texas Instruments Inc'},
    {symbol: 'RTX', name: 'Raytheon Technologies'},
    {symbol: 'SPGI', name: 'S&P Global Inc'},
    {symbol: 'NOW', name: 'ServiceNow Inc'},
    {symbol: 'NEE', name: 'NextEra Energy Inc'},
    {symbol: 'LOW', name: 'Lowe\'s Companies Inc'},
    {symbol: 'QCOM', name: 'QUALCOMM Inc'},
    {symbol: 'UNP', name: 'Union Pacific Corporation'},
    {symbol: 'CAT', name: 'Caterpillar Inc'},
    {symbol: 'AMGN', name: 'Amgen Inc'},
    {symbol: 'HON', name: 'Honeywell International'},
    {symbol: 'AMD', name: 'Advanced Micro Devices'},
    {symbol: 'SCHW', name: 'Charles Schwab Corporation'},
    {symbol: 'PFE', name: 'Pfizer Inc'},
    {symbol: 'AXP', name: 'American Express Company'},
    {symbol: 'SYK', name: 'Stryker Corporation'},
    {symbol: 'GE', name: 'General Electric Company'},
    {symbol: 'BSX', name: 'Boston Scientific Corporation'},
    {symbol: 'DE', name: 'Deere & Company'},
    {symbol: 'BLK', name: 'BlackRock Inc'},
    {symbol: 'MDT', name: 'Medtronic plc'},
    {symbol: 'GILD', name: 'Gilead Sciences Inc'},
    {symbol: 'C', name: 'Citigroup Inc'},
    {symbol: 'VRTX', name: 'Vertex Pharmaceuticals'},
    {symbol: 'MMC', name: 'Marsh & McLennan Companies'},
    {symbol: 'AON', name: 'Aon plc'},
    {symbol: 'LRCX', name: 'Lam Research Corporation'},
    {symbol: 'ADI', name: 'Analog Devices Inc'},
    {symbol: 'ADP', name: 'Automatic Data Processing'},
    {symbol: 'MDLZ', name: 'Mondelez International'},
    {symbol: 'KLAC', name: 'KLA Corporation'},
    {symbol: 'CI', name: 'Cigna Corporation'},
    {symbol: 'SHW', name: 'Sherwin-Williams Company'},
    {symbol: 'ZTS', name: 'Zoetis Inc'},
    {symbol: 'CB', name: 'Chubb Limited'},
    {symbol: 'REGN', name: 'Regeneron Pharmaceuticals'},
    {symbol: 'PYPL', name: 'PayPal Holdings Inc'},
    {symbol: 'SO', name: 'Southern Company'},
    {symbol: 'DUK', name: 'Duke Energy Corporation'},
    {symbol: 'CMG', name: 'Chipotle Mexican Grill'},
    {symbol: 'PGR', name: 'Progressive Corporation'},
    {symbol: 'ITW', name: 'Illinois Tool Works'},
    {symbol: 'TGT', name: 'Target Corporation'},
    {symbol: 'USB', name: 'U.S. Bancorp'},
    {symbol: 'MMM', name: '3M Company'},
    {symbol: 'MU', name: 'Micron Technology Inc'},
    {symbol: 'APH', name: 'Amphenol Corporation'},
    {symbol: 'TJX', name: 'TJX Companies Inc'},
    {symbol: 'BDX', name: 'Becton Dickinson and Company'},
    {symbol: 'MO', name: 'Altria Group Inc'},
    {symbol: 'NSC', name: 'Norfolk Southern Corporation'},
    {symbol: 'ISRG', name: 'Intuitive Surgical Inc'},
    {symbol: 'HCA', name: 'HCA Healthcare Inc'},
    {symbol: 'NKE', name: 'NIKE Inc'},
    {symbol: 'CVS', name: 'CVS Health Corporation'},
    {symbol: 'FI', name: 'Fiserv Inc'},
    {symbol: 'COP', name: 'ConocoPhillips'},
    {symbol: 'ETN', name: 'Eaton Corporation plc'},
    {symbol: 'PLD', name: 'Prologis Inc'},
    {symbol: 'APD', name: 'Air Products and Chemicals'},
    {symbol: 'CL', name: 'Colgate-Palmolive Company'},
    {symbol: 'AMAT', name: 'Applied Materials Inc'},
    {symbol: 'GS', name: 'Goldman Sachs Group Inc'},
    {symbol: 'FCX', name: 'Freeport-McMoRan Inc'},
    {symbol: 'SLB', name: 'Schlumberger Limited'},
    {symbol: 'EQIX', name: 'Equinix Inc'},
    {symbol: 'CSX', name: 'CSX Corporation'},
    {symbol: 'MPC', name: 'Marathon Petroleum Corporation'},
    {symbol: 'NOC', name: 'Northrop Grumman Corporation'},
    {symbol: 'EMR', name: 'Emerson Electric Co'},
    {symbol: 'SNPS', name: 'Synopsys Inc'},
    {symbol: 'TT', name: 'Trane Technologies plc'},
    {symbol: 'F', name: 'Ford Motor Company'},
    {symbol: 'HUM', name: 'Humana Inc'},
    {symbol: 'CDNS', name: 'Cadence Design Systems'},
    {symbol: 'SPY', name: 'SPDR S&P 500 ETF Trust'},
    {symbol: 'QQQ', name: 'Invesco QQQ Trust'},
    {symbol: 'IWM', name: 'iShares Russell 2000 ETF'},
    {symbol: 'EFA', name: 'iShares MSCI EAFE ETF'},
    {symbol: 'VTI', name: 'Vanguard Total Stock Market ETF'},
    {symbol: 'VOO', name: 'Vanguard S&P 500 ETF'},
    {symbol: 'GLD', name: 'SPDR Gold Shares'},
    {symbol: 'SLV', name: 'iShares Silver Trust'},
    {symbol: 'TLT', name: '20+ Year Treasury Bond ETF'},
    {symbol: 'HYG', name: 'iShares iBoxx High Yield Corporate Bond ETF'},
    {symbol: 'XLF', name: 'Financial Select Sector SPDR Fund'},
    {symbol: 'XLE', name: 'Energy Select Sector SPDR Fund'},
    {symbol: 'XLK', name: 'Technology Select Sector SPDR Fund'},
    {symbol: 'XLV', name: 'Health Care Select Sector SPDR Fund'},
    {symbol: 'XLI', name: 'Industrial Select Sector SPDR Fund'},
    {symbol: 'XLY', name: 'Consumer Discretionary Select Sector SPDR Fund'},
    {symbol: 'XLP', name: 'Consumer Staples Select Sector SPDR Fund'},
    {symbol: 'XLRE', name: 'Real Estate Select Sector SPDR Fund'},
    {symbol: 'XLU', name: 'Utilities Select Sector SPDR Fund'},
    {symbol: 'XLB', name: 'Materials Select Sector SPDR Fund'},
    {symbol: 'BA', name: 'Boeing Company'},
    {symbol: 'DIS', name: 'Walt Disney Company'},
    {symbol: 'INTC', name: 'Intel Corporation'},
    {symbol: 'IBM', name: 'International Business Machines'},
    {symbol: 'T', name: 'AT&T Inc'},
    {symbol: 'GME', name: 'GameStop Corp'},
    {symbol: 'AMC', name: 'AMC Entertainment Holdings'},
    {symbol: 'BB', name: 'BlackBerry Limited'},
    {symbol: 'NOK', name: 'Nokia Corporation'},
    {symbol: 'PLTR', name: 'Palantir Technologies Inc'},
    {symbol: 'NIO', name: 'NIO Inc'},
    {symbol: 'RIOT', name: 'Riot Platforms Inc'},
    {symbol: 'MARA', name: 'Marathon Digital Holdings'},
    {symbol: 'COIN', name: 'Coinbase Global Inc'},
    {symbol: 'SQ', name: 'Block Inc'},
    {symbol: 'HOOD', name: 'Robinhood Markets Inc'},
    {symbol: 'SOFI', name: 'SoFi Technologies Inc'},
    {symbol: 'AA', name: 'Alcoa Corporation'},
    {symbol: 'X', name: 'United States Steel Corporation'},
    {symbol: 'NUE', name: 'Nucor Corporation'},
    {symbol: 'F', name: 'Ford Motor Company'},
    {symbol: 'GM', name: 'General Motors Company'}
];

// Simple autocomplete functionality for add trade page
function initializeAutocomplete() {
    const symbolInput = document.getElementById('symbol-input');
    if (!symbolInput) return; // Exit if input not found
    
    const dropdown = document.createElement('div');
    dropdown.className = 'autocomplete-dropdown';
    dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10000;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    `;
    
    symbolInput.parentNode.style.position = 'relative';
    symbolInput.parentNode.style.zIndex = '10000';
    symbolInput.parentNode.appendChild(dropdown);
    
    let selectedIndex = -1;
    
    function showDropdown(matches) {
        dropdown.innerHTML = '';
        if (matches.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        matches.forEach((stock, index) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                font-size: 14px;
            `;
            item.innerHTML = `<strong>${stock.symbol}</strong> ‚Äî ${stock.name}`;
            
            item.addEventListener('mouseenter', () => {
                selectedIndex = index;
                updateSelection();
            });
            
            item.addEventListener('click', () => {
                symbolInput.value = stock.symbol;
                dropdown.style.display = 'none';
                selectedIndex = -1;
                
                // Auto-load chart when symbol is selected
                setTimeout(() => {
                    const loadButton = document.getElementById('load-chart');
                    if (loadButton) {
                        loadButton.click();
                    }
                }, 100);  // Small delay to ensure symbol is set
            });
            
            dropdown.appendChild(item);
        });
        
        dropdown.style.display = 'block';
        selectedIndex = -1;
        updateSelection();
    }
    
    function updateSelection() {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#e6f3ff';
            } else {
                item.style.backgroundColor = 'white';
            }
        });
    }
    
    function hideDropdown() {
        setTimeout(() => {
            dropdown.style.display = 'none';
            selectedIndex = -1;
        }, 150);
    }
    
    symbolInput.addEventListener('input', (e) => {
        const query = e.target.value.trim().toUpperCase();
        if (query.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        const matches = POPULAR_STOCKS.filter(stock => 
            stock.symbol.includes(query) || 
            stock.name.toUpperCase().includes(query)
        ).slice(0, 10);
        
        showDropdown(matches);
    });
    
    symbolInput.addEventListener('keydown', (e) => {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            const selectedStock = POPULAR_STOCKS.filter(stock => 
                stock.symbol.includes(symbolInput.value.trim().toUpperCase()) || 
                stock.name.toUpperCase().includes(symbolInput.value.trim().toUpperCase())
            )[selectedIndex];
            
            if (selectedStock) {
                symbolInput.value = selectedStock.symbol;
                dropdown.style.display = 'none';
                selectedIndex = -1;
                
                // Auto-load chart when symbol is selected via Enter
                setTimeout(() => {
                    const loadButton = document.getElementById('load-chart');
                    if (loadButton) {
                        loadButton.click();
                    }
                }, 100);
            }
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    symbolInput.addEventListener('blur', hideDropdown);
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!symbolInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            selectedIndex = -1;
        }
    });
}

// Initialize autocomplete when page loads
document.addEventListener('DOMContentLoaded', initializeAutocomplete);

// Planned trade checkbox handler
document.addEventListener('DOMContentLoaded', function() {
    const isPlannedCheckbox = document.getElementById('is_planned');
    const entryOptionalText = document.getElementById('entry-optional-text');
    const saveBtn = document.getElementById('save-btn');
    const savePlannedBtn = document.getElementById('save-planned-btn');
    const savePlannedAnalyzeBtn = document.getElementById('save-planned-analyze-btn');
    
    function togglePlannedMode() {
        const isPlanned = isPlannedCheckbox.checked;
        
        if (isPlanned) {
            // Show planned mode
            entryOptionalText.style.display = 'inline';
            saveBtn.style.display = 'none';
            savePlannedBtn.style.display = 'inline-block';
            savePlannedAnalyzeBtn.style.display = 'inline-block';
        } else {
            // Show normal mode
            entryOptionalText.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            savePlannedBtn.style.display = 'none';
            savePlannedAnalyzeBtn.style.display = 'none';
        }
    }
    
    if (isPlannedCheckbox) {
        isPlannedCheckbox.addEventListener('change', togglePlannedMode);
        // Initialize on page load
        togglePlannedMode();
    }
});

// Auto-fill current date/time for entry if empty
document.addEventListener('DOMContentLoaded', function() {
    const entryDateField = document.getElementById('entry_date');
    if (entryDateField && !entryDateField.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        entryDateField.value = `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // Initialize options fields visibility
    toggleOptionsFields();
    
    // Add event listener for trade type changes
    const tradeTypeField = document.getElementById('trade_type');
    if (tradeTypeField) {
        tradeTypeField.addEventListener('change', toggleOptionsFields);
    }
});

function toggleOptionsFields() {
    const tradeType = document.getElementById('trade_type').value;
    const optionsFields = document.getElementById('options-fields');
    const spreadFields = document.getElementById('spread-fields');
    const entryPriceLabel = document.getElementById('entry-price-label');
    const entryPriceHelp = document.getElementById('entry-price-help');
    const quantityLabel = document.getElementById('quantity-label');
    const quantityHelp = document.getElementById('quantity-help');
    
    const isOption = tradeType === 'option_call' || tradeType === 'option_put';
    const isSpread = tradeType === 'credit_put_spread' || tradeType === 'credit_call_spread';
    
    // Show/hide options fields
    if (optionsFields) {
        optionsFields.style.display = (isOption && !isSpread) ? 'block' : 'none';
    }
    
    // Show/hide spread fields
    if (spreadFields) {
        spreadFields.style.display = isSpread ? 'block' : 'none';
    }
    
    // Update labels and help text
    if (isSpread) {
        if (entryPriceLabel) entryPriceLabel.textContent = 'Exit Premium ($)';
        if (entryPriceHelp) entryPriceHelp.textContent = 'Premium paid to close the spread (if closed early)';
        if (quantityLabel) quantityLabel.textContent = 'Number of Spreads';
        if (quantityHelp) quantityHelp.textContent = 'Number of spread contracts';
    } else if (isOption) {
        if (entryPriceLabel) entryPriceLabel.textContent = 'Premium Per Contract ($)';
        if (entryPriceHelp) entryPriceHelp.textContent = 'Premium paid per contract';
        if (quantityLabel) quantityLabel.textContent = 'Number of Contracts';
        if (quantityHelp) quantityHelp.textContent = 'Number of option contracts';
    } else {
        if (entryPriceLabel) entryPriceLabel.textContent = 'Entry Price ($)';
        if (entryPriceHelp) entryPriceHelp.textContent = 'Price per share';
        if (quantityLabel) quantityLabel.textContent = 'Quantity/Shares';
        if (quantityHelp) quantityHelp.textContent = 'Number of shares';
    }
    
    // Update form validation requirements
    updateValidationRequirements(isOption || isSpread);
}

function updateValidationRequirements(isOption) {
    const strikePrice = document.querySelector('input[name="strike_price"]');
    const expirationDate = document.querySelector('input[name="expiration_date"]');
    
    if (strikePrice && expirationDate) {
        if (isOption) {
            strikePrice.setAttribute('required', 'required');
            expirationDate.setAttribute('required', 'required');
        } else {
            strikePrice.removeAttribute('required');
            expirationDate.removeAttribute('required');
        }
    }
}

// Calculate option metrics automatically
function calculateOptionMetrics() {
    const strikePrice = parseFloat(document.querySelector('input[name="strike_price"]').value) || 0;
    const underlyingPrice = parseFloat(document.querySelector('input[name="underlying_price_at_entry"]').value) || 0;
    const premium = parseFloat(document.querySelector('input[name="entry_price"]').value) || 0;
    const tradeType = document.getElementById('trade_type').value;
    
    if (strikePrice && underlyingPrice && premium) {
        let intrinsicValue = 0;
        
        if (tradeType === 'option_call') {
            intrinsicValue = Math.max(0, underlyingPrice - strikePrice);
        } else if (tradeType === 'option_put') {
            intrinsicValue = Math.max(0, strikePrice - underlyingPrice);
        }
        
        const timeValue = Math.max(0, premium - intrinsicValue);
        
        // You could display these calculated values in the UI
        console.log('Intrinsic Value:', intrinsicValue);
        console.log('Time Value:', timeValue);
    }
}

// Add event listeners for automatic calculations
document.addEventListener('DOMContentLoaded', function() {
    const calculationFields = [
        'input[name="strike_price"]',
        'input[name="underlying_price_at_entry"]',
        'input[name="entry_price"]'
    ];
    
    calculationFields.forEach(selector => {
        const field = document.querySelector(selector);
        if (field) {
            field.addEventListener('input', calculateOptionMetrics);
        }
    });
});
</script>

<!-- Chart & Levels JavaScript -->
<script>
const el = document.getElementById('tradeChart');
let chartData = null;
let layout = {
    dragmode: 'zoom',
    margin: {l:40,r:8,t:20,b:20},
    xaxis: {type:'date', rangeslider:{visible:false}},
    yaxis: {fixedrange:false},
    shapes: []
};

function isEquitySymbol(sym) {
    // crude but effective: you can refine by lookup later
    return /^[A-Z.\-]{1,6}$/.test(sym);
}

// Auto timeframe picker based on zoom window
function pickTF(windowMs) {
    const MS_DAY = 86400000;
    if (windowMs <= 3*MS_DAY)   return '1m';
    if (windowMs <= 14*MS_DAY)  return '5m';
    if (windowMs <= 180*MS_DAY) return '1h';
    if (windowMs <= 540*MS_DAY) return '4h';   // NEW
    return '1d';
}

// Helper: set x range by label
function setRangeByLabel(label){
    const MS_DAY = 86400000;  // Define MS_DAY locally (24 * 60 * 60 * 1000)
    const now = buffer.t.length ? new Date(buffer.t[buffer.t.length-1]) : new Date();
    let start;
    const d = (n)=>new Date(now.getTime() - n*MS_DAY);

    switch(label){
        case '1D':  start = d(1);  break;
        case '5D':  start = d(5);  break;
        case '1M':  start = d(30); break;
        case '3M':  start = d(90); break;
        case '6M':  start = d(180);break;
        case 'YTD': start = new Date(new Date(now.getFullYear(),0,1)); break;
        case '1Y':  start = d(365); break;
        case 'ALL': start = new Date(buffer.t[0]); break;
        default: return;
    }
    Plotly.relayout(el, {'xaxis.range':[start, now], 'xaxis.autorange': false, 'yaxis.autorange': true});
}

// Helper: get current range
function currentRange(){
    const r = el.layout?.xaxis?.range;
    if (r && r.length===2) return [new Date(r[0]), new Date(r[1])];
    const last = buffer.t[buffer.t.length-1];
    return [new Date(last-5*MS_DAY), new Date(last)]; // fallback
}

// Helper: merge bars (for backfill)
function mergeBars(a, b) {
    const all = [...a.t.map((t,i)=>({t,o:a.o[i],h:a.h[i],l:a.l[i],c:a.c[i],v:a.v[i]})),
                  ...b.t.map((t,i)=>({t,o:b.o[i],h:b.h[i],l:b.l[i],c:b.c[i],v:b.v[i]}))];
    all.sort((x,y)=>x.t-y.t);
    const seen = new Set();
    const unique = all.filter(x=>{
        if(seen.has(x.t)) return false;
        seen.add(x.t);
        return true;
    });
    return {
        t: unique.map(x=>x.t),
        o: unique.map(x=>x.o),
        h: unique.map(x=>x.h),
        l: unique.map(x=>x.l),
        c: unique.map(x=>x.c),
        v: unique.map(x=>x.v)
    };
}

// Helper: fetch range
async function fetchRange(symbol, tf, startISO, endISO) {
    const params = new URLSearchParams({ symbol, tf });
    if (tf === '1d') {
        const start = new Date(Date.now() - 3650*24*3600*1000).toISOString().slice(0,10);
        params.set('start', start);
    } else if (startISO) {
        params.set('start', startISO);
    }
    if (endISO) params.set('end', endISO);
    
    const res = await fetch(`/api/candles?${params.toString()}`);
    const j = await res.json();
    if (j.error) throw new Error(j.error);
    return j;
}

// Return Plotly rangebreaks that hide nights/weekends but keep PM/AH if requested.
function buildRangebreaks({ includePM=true, includeAH=true, hideClosed=true }) {
    if (!hideClosed) return [];
    const breaks = [
        // Hide full weekends
        { pattern: 'day of week', bounds: ['sat', 'mon'] },
    ];
    
    // Hide the overnight period from market close (16:00/4PM) to market open (09:30/9:30AM)
    // This covers: 16:00-24:00 and 00:00-09:30 on each trading day
    breaks.push({ pattern: 'hour', bounds: [16, 24] }); // Market close (4 PM) to midnight
    breaks.push({ pattern: 'hour', bounds: [0, 9] });    // Midnight to 9 AM
    
    // Hide 9:00-9:30 AM (pre-market gap before 9:30 market open) unless PM is included
    // Use values pattern with daily repeating template
    if (!includePM) {
        breaks.push({ 
            values: ['1970-01-01 09:00', '1970-01-01 09:30']  // Hides 9:00-9:30 AM daily
        });
    }
    
    // The breaks above ensure:
    // - Weekends are hidden
    // - Market close (16:00/4 PM) to market open (09:30/9:30 AM) is hidden
    // - 9:00-9:30 AM gap is hidden unless pre-market is enabled
    // - After-hours period (16:00+) is hidden by the [16, 24] break
    
    return breaks;
}

// Apply rangebreaks based on current UI + timeframe.
// For daily TF, we only need weekend break; intraday uses full set above.
function applyRangebreaks(symbol, tf) {
    const includePM = document.getElementById('include-premarket')?.checked ?? true;
    const includeAH = document.getElementById('include-afterhours')?.checked ?? true;
    const hideClosed = document.getElementById('hide-closed')?.checked ?? true;

    let rb = [];
    if (tf === '1d') {
        // daily: hide weekends; nights are irrelevant at 1D granularity
        rb = hideClosed ? [{ pattern:'day of week', bounds:['sat','mon'] }] : [];
    } else {
        // For 4h and shorter timeframes, always apply comprehensive rangebreaks to remove gaps
        const isShortTF = ['4h', '1h', '30m', '15m', '5m', '1m'].includes(tf);
        if (isShortTF && hideClosed) {
            // Force hideClosed=true for short timeframes to remove all gaps
            rb = buildRangebreaks({ includePM, includeAH, hideClosed: true });
        } else {
            rb = buildRangebreaks({ includePM, includeAH, hideClosed });
        }
    }

    // Note: Plotly uses the viewer's local timezone for axis labels/tooltips.
    // Your Tiingo timestamps are UTC; that's fine‚Äîbreaks still apply to displayed local time.
    layout.xaxis = {
        ...(layout.xaxis || {}),
        type: 'date',
        rangeslider: { visible: false },
        rangebreaks: rb,
        autorange: layout.xaxis?.autorange !== undefined ? layout.xaxis.autorange : true  // Preserve autorange setting
    };
}

// Remove zero-volume / NaN bars so PM/AH only shows executed trades
function filterBars(j) {
    const t=[] , o=[], h=[], l=[], c=[], v=[];
    for (let i=0; i<j.t.length; i++) {
        const vi = j.v?.[i] ?? 0;
        const oi = j.o[i], hi=j.h[i], li=j.l[i], ci=j.c[i];
        // keep daily bars as-is; for intraday, drop bars with zero volume or NaN
        const isValid = Number.isFinite(oi)&&Number.isFinite(hi)&&Number.isFinite(li)&&Number.isFinite(ci) && (vi>0 || j.t.length<=400);
        if (isValid) { t.push(j.t[i]); o.push(oi); h.push(hi); l.push(li); c.push(ci); v.push(vi); }
    }
    return { t, o, h, l, c, v };
}

async function loadCandles() {
    const symbol = (document.getElementById('symbol-input')?.value || 'AAPL').toUpperCase();
    const tf = document.getElementById('chart-timeframe').value;
    
    currentSymbol = symbol;
    currentTF = tf;
    
    const params = new URLSearchParams({ symbol, tf });
    if (tf === '1d') {
        // pull ~10 years by default
        const start = new Date(Date.now() - 3650*24*3600*1000).toISOString().slice(0,10);
        params.set('start', start);
    }
    
    const res = await fetch(`/api/candles?${params.toString()}`);
    let j = await res.json();
    if (j.error) { 
        alert(j.error); 
        return; 
    }

    // Filter out empty bars for intraday so we don't plot "flat" closed periods
    if (tf !== '1d') j = filterBars(j);

    chartData = j;
    buffer = j; // Store in buffer for backfill system
    
    // Clear any stale range and explicitly enable autorange for both axes BEFORE applying rangebreaks
    // This ensures autorange is preserved when rangebreaks update the layout
    delete layout.xaxis.range;
    layout.xaxis.autorange = true;
    layout.yaxis = { ...(layout.yaxis || {}), autorange: true, fixedrange: false };
    
    // Apply rangebreaks (skip closed time), only for typical equities
    // This will update layout.xaxis but autorange=true is already set above
    if (isEquitySymbol(symbol)) {
        applyRangebreaks(symbol, tf);
        // Ensure autorange stays true after rangebreaks update
        layout.xaxis.autorange = true;
    } else {
        // e.g., crypto/FX leave empty to show 24/7
        layout.xaxis = {
            ...(layout.xaxis || {}),
            type: 'date',
            rangeslider: { visible: false },
            rangebreaks: [],
            autorange: true
        };
    }

    const trace = {
        type: 'candlestick',
        x: j.t.map(ts => new Date(ts)),
        open: j.o, high: j.h, low: j.l, close: j.c,
        name: symbol,
        increasing: {line:{width:1}},
        decreasing: {line:{width:1}}
    };

    Plotly.newPlot(el, [trace], layout, {
        responsive: true,
        displaylogo: false,
        modeBarButtonsToAdd: ['zoom2d','pan2d','resetScale2d','autoscale','drawline','drawrect','eraseshape']
    });
    
    // Connect the onRelayout handler for deep backfill
    el.on('plotly_relayout', onRelayout);
    
    // Setup axis scroll zoom after chart is loaded
    setTimeout(setupAxisScrollZoom, 200);
    
    // Auto-zoom to recent data, then show S/R levels and expected move
    setTimeout(async () => {
        // Calculate appropriate zoom window based on timeframe
        const bars = j.t.length;
        let recentBars = bars;
        const tf = document.getElementById('chart-timeframe').value;
        
        // Determine how many bars to show based on timeframe
        const barCounts = {
            '1m': 120,   // last ~2 hours
            '5m': 96,    // last ~8 hours  
            '15m': 96,   // last ~24 hours
            '30m': 84,   // last ~42 hours (1.75 days)
            '1h': 120,   // last 5 days
            '4h': 84,    // last 2 weeks
            '1d': 90     // last 3 months
        };
        recentBars = Math.min(bars, barCounts[tf] || 90);
        
        if (bars > recentBars) {
            // Zoom to show only the most recent bars
            const startIdx = bars - recentBars;
            const startTime = new Date(j.t[startIdx]);
            const endTime = new Date(j.t[bars - 1]);
            await Plotly.relayout(el, {
                'xaxis.range': [startTime, endTime],
                'xaxis.autorange': false,
                'yaxis.autorange': true
            });
        }
        
        // Auto-mark support/resistance levels
        try {
            await autoLevels();
        } catch (err) {
            console.warn('Auto-levels failed:', err);
        }
        
        // Auto-show expected move and scenarios
        try {
            await runExplain();
        } catch (err) {
            console.warn('Auto-explain failed:', err);
        }
    }, 300); // Wait for chart to fully render
}

// Improved onRelayout with deep backfill fix
const onRelayout = debounce(async (ev) => {
    if (fetching) return;

    // 1) get visible window
    const x0 = ev['xaxis.range[0]'] || el.layout?.xaxis?.range?.[0];
    const x1 = ev['xaxis.range[1]'] || el.layout?.xaxis?.range?.[1];
    if (!x0 || !x1) return;
    const left  = new Date(x0).getTime();
    const right = new Date(x1).getTime();
    const windowMs = right - left;

    // 2) choose best TF for this window
    const newTF = pickTF(windowMs);
    const tfChanged = newTF !== currentTF;

    // 3) find current coverage
    const minTs = buffer.t.length ? buffer.t[0] : left;
    const maxTs = buffer.t.length ? buffer.t[buffer.t.length-1] : right;

    // if the new visible window extends beyond our data, fetch to fully cover it (+padding)
    const PAD = Math.max(0.25*windowMs, 2*MS_DAY); // always pad at least 2 days
    const needStart = left  < (minTs + 6e4);  // left edge earlier than earliest buffered?
    const needEnd   = right > (maxTs - 6e4);  // right edge later than latest buffered?

    try {
        fetching = true;

        // If timeframe changed ‚Üí reload the whole visible window with that TF
        if (tfChanged) {
            currentTF = newTF;
            const startISO = new Date(left - PAD).toISOString().slice(0,16).replace('T',' ');
            const endISO   = new Date(right + PAD).toISOString().slice(0,16).replace('T',' ');
            const j = await fetchRange(currentSymbol, currentTF, startISO, endISO);
            buffer = j;

            applyRangebreaks(currentSymbol, currentTF);
            await Plotly.react(el, [{
                type:'candlestick',
                x: buffer.t.map(ts=>new Date(ts)),
                open:buffer.o, high:buffer.h, low:buffer.l, close:buffer.c,
                name: currentSymbol, increasing:{line:{width:1}}, decreasing:{line:{width:1}}
            }], {...layout, yaxis:{fixedrange:false, autorange:true}}, {responsive:true, displaylogo:false});

            await Plotly.relayout(el, {'xaxis.range':[new Date(left), new Date(right)]});
        } else {
            // Same TF but we zoomed beyond the buffer: fetch the missing sides

            if (needStart) {
                const wantStart = new Date(left - PAD);
                const wantEnd   = new Date(minTs - 6e4);
                const jL = await fetchRange(currentSymbol, currentTF, wantStart.toISOString().slice(0,10), wantEnd.toISOString().slice(0,10));
                buffer = mergeBars(buffer, jL);
            }
            if (needEnd) {
                const wantStart = new Date(maxTs + 6e4);
                const wantEnd   = new Date(right + PAD);
                const jR = await fetchRange(currentSymbol, currentTF, wantStart.toISOString().slice(0,10), wantEnd.toISOString().slice(0,10));
                buffer = mergeBars(buffer, jR);
            }

            if (needStart || needEnd) {
                await Plotly.restyle(el, {
                    x: [buffer.t.map(ts=>new Date(ts))],
                    open:[buffer.o], high:[buffer.h], low:[buffer.l], close:[buffer.c]
                }, [0]);
                await Plotly.relayout(el, {'xaxis.range':[new Date(left), new Date(right)], 'yaxis.autorange': true});
            }
        }
    } catch (err) {
        console.warn('relayout fetch error', err.message);
    } finally {
        fetching = false;
    }
}, 200);

// Debounce helper
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function autoLevels() {
    if (!chartData) return;
    const major = document.getElementById('major-only').checked ? "1":"0";
    const circles = document.getElementById('show-circles').checked ? "1":"0";
    const style = document.getElementById('level-style').value;
    const max = document.getElementById('max-levels').value;

    const res = await fetch(`/api/ai/sr-levels?major=${major}&circles=${circles}&style=${style}&max=${max}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(chartData)
    });
    const { level_shapes, pivot_circles, levels } = await res.json();

    // replace previous AI levels instead of piling on
    const keep = (el._fullLayout.shapes || []).filter(s => !(s._generated_by === 'ai_major'));
    const tagged = (arr) => arr.map(s => ({...s, _generated_by:'ai_major'}));
    layout.shapes = keep.concat(tagged(level_shapes), tagged(pivot_circles));
    Plotly.relayout(el, {shapes: layout.shapes});

    // NEW: legend
    renderLevelLegend(levels || []);
}

function formatPx(n){ return (+n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

function renderLevelLegend(levels=[]) {
    const elLegend = document.getElementById('level-legend');
    if (!elLegend) return;
    if (!levels.length) { elLegend.innerHTML = ""; return; }

    const badges = levels.map((p,i)=>`<span class="badge bg-info-subtle text-info-emphasis">L${i+1}: ${formatPx(p)}</span>`).join("");
    elLegend.innerHTML = `<span class="legend-title">Major levels:</span>${badges}`;
}

async function saveSnapshot() {
    // Save annotations JSON
    const gd = el;
    const fullLayout = gd._fullLayout;
    const shapes = (fullLayout.shapes || []).map(s => ({...s, x0: s.x0, x1: s.x1, y0: s.y0, y1: s.y1}));
    document.getElementById('chart_annotations_json').value = JSON.stringify({shapes});

    // Save PNG to server
    const dataUrl = await Plotly.toImage(el, {format:'png', width:1200, height:600, scale:2});
    const up = await fetch('/api/upload-chart', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dataUrl})});
    const j = await up.json();
    if (j.path) {
        document.getElementById('chart_snapshot_path').value = j.path;
        alert('Chart snapshot attached to this trade.');
    } else {
        alert('Could not save snapshot.');
    }
}

document.getElementById('load-chart').addEventListener('click', loadCandles);
document.getElementById('auto-levels').addEventListener('click', autoLevels);
document.getElementById('save-snapshot').addEventListener('click', saveSnapshot);

// Explain this chart (timeframe-aware)
async function runExplain(){
  const symbol = (document.getElementById('symbol-input')?.value || 'AAPL').toUpperCase();
  const tf = document.getElementById('chart-timeframe')?.value || '1d';
  const r = await fetch('/api/ai/explain_chart', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ symbol, timeframes:[tf], context:{ include_expected_move:true }, user_risk_prefs:{ risk_per_trade_pct: 1.0 } })
  });
  const data = await r.json();
  const tfb = (data.timeframes||[])[0];
  const elOut = document.getElementById('explain-result');
  if(!tfb){ elOut.innerHTML = '<div class="text-muted">No analysis</div>'; return; }
  const em = tfb.expected_move, lv = tfb.levels;

  elOut.innerHTML = `
    <div class="card border-info">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">${data.symbol} ‚Ä¢ ${tfb.tf.toUpperCase()}</h6>
          <div class="small text-muted">ATR(14) ${em.atr.toFixed(2)} ‚Ä¢ EM ¬±${(em.atr*em.atr_mult).toFixed(2)} ‚Üí ${em.lower.toFixed(2)} / ${em.upper.toFixed(2)}</div>
        </div>
        <div class="small mt-1 text-muted">Levels: L ${lv.recent_low} ‚Ä¢ Mid ${lv.mid} ‚Ä¢ H ${lv.recent_high}</div>
        <div class="mt-2 d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-outline-info" onclick='showEMBand({lower: ${em.lower}, upper: ${em.upper}})'>Show Expected Move</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="clearEMBand()">Clear EM</button>
        </div>
        <div class="row g-2 mt-2">
          ${tfb.scenarios.map(s=>`
            <div class="col-md-6">
              <div class="border rounded p-2 h-100">
                <div class="small text-muted">${s.direction.toUpperCase()} ‚Ä¢ ${s.playbook} ‚Ä¢ ${(s.probability*100).toFixed(0)}%</div>
                <div class="fw-semibold">Trigger: ${s.trigger}</div>
                <div class="small">Entry ${s.entry_zone[0]}‚Äì${s.entry_zone[1]} ‚Ä¢ Stop ${s.invalidation} ‚Ä¢ T1/T2/T3 ${s.targets.join('/')}</div>
                <div class="small text-muted">R:R ${s.r_r}</div>
                <div class="small mt-1">${s.notes}</div>
                <div class="mt-2 d-flex gap-2 flex-wrap">
                  <button class="btn btn-sm ${s.direction==='bull'?'btn-success':'btn-danger'}"
                          onclick="showScenarioZones({ direction: '${s.direction}', entry0: ${s.entry_zone[0]}, entry1: ${s.entry_zone[1]}, stop: ${s.invalidation}, t1: ${s.targets[0]}, t2: ${s.targets[1]}, t3: ${s.targets[2]} })">
                    Show ${s.direction==='bull'?'Bull':'Bear'} zones
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="clearScenarioZones()">Clear zones</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>`;
}
document.getElementById('explain-btn').addEventListener('click', runExplain);

document.getElementById('clear-levels').addEventListener('click', () => {
    layout.shapes = (el._fullLayout.shapes || []).filter(s => !(s._generated_by === 'ai_major'));
    Plotly.relayout(el, {shapes: layout.shapes});
    renderLevelLegend([]); // clear legend
});

// Re-apply rangebreaks when toggles change
['include-premarket','include-afterhours','hide-closed'].forEach(id=>{
    const elToggle = document.getElementById(id);
    if (!elToggle) return;
    elToggle.addEventListener('change', async ()=>{
        if (chartData) {
            const symbol = (document.getElementById('symbol-input')?.value || 'AAPL').toUpperCase();
            const tf = document.getElementById('chart-timeframe').value;
            applyRangebreaks(symbol, tf);
            // Just relayout to apply the new breaks without touching data
            await Plotly.relayout(el, { xaxis: layout.xaxis });
        }
    });
});

// Auto-reload chart when timeframe changes
document.getElementById('chart-timeframe').addEventListener('change', () => {
    // Only auto-reload if a chart is already loaded
    if (chartData) {
        const loadButton = document.getElementById('load-chart');
        if (loadButton) {
            loadButton.click();
        }
    }
    // If explain panel is visible, refresh analysis for new timeframe
    if (document.getElementById('explain-result').innerHTML.trim()) {
        clearEMBand(); clearScenarioZones();
        runExplain();
    }
});

// Wire preset buttons
document.querySelectorAll('[data-zoom]').forEach(btn=>{
    btn.addEventListener('click', ()=> setRangeByLabel(btn.dataset.zoom));
});

// Zoom/Pan step controls
document.getElementById('zoom-in').addEventListener('click', ()=>{
    const [a,b]=currentRange(); const mid=(a.getTime()+b.getTime())/2; const span=(b-a)/2;
    Plotly.relayout(el, {'xaxis.range':[new Date(mid-span/2), new Date(mid+span/2)], 'xaxis.autorange': false, 'yaxis.autorange': true});
});
document.getElementById('zoom-out').addEventListener('click', ()=>{
    const [a,b]=currentRange(); const mid=(a.getTime()+b.getTime())/2; const span=(b-a);
    Plotly.relayout(el, {'xaxis.range':[new Date(mid-1.5*span), new Date(mid+1.5*span)], 'xaxis.autorange': false, 'yaxis.autorange': true});
});
document.getElementById('pan-left').addEventListener('click', ()=>{
    const [a,b]=currentRange(); const span=(b-a);
    Plotly.relayout(el, {'xaxis.range':[new Date(a-span*0.5), new Date(b-span*0.5)], 'xaxis.autorange': false});
});
document.getElementById('pan-right').addEventListener('click', ()=>{
    const [a,b]=currentRange(); const span=(b-a);
    Plotly.relayout(el, {'xaxis.range':[new Date(a+span*0.5), new Date(b+span*0.5)], 'xaxis.autorange': false});
});
document.getElementById('reset').addEventListener('click', ()=>{
    Plotly.relayout(el, {'xaxis.autorange': true, 'yaxis.autorange': true});
});

// Draw tool toggles
document.querySelectorAll('[data-draw]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        const mode = btn.dataset.draw;
        if (mode === 'zoom')  return Plotly.relayout(el, {dragmode:'zoom'});
        if (mode === 'pan')   return Plotly.relayout(el, {dragmode:'pan'});
        if (mode === 'line')  return Plotly.relayout(el, {dragmode:'drawline'});
        if (mode === 'rect')  return Plotly.relayout(el, {dragmode:'drawrect'});
        if (mode === 'erase') return Plotly.relayout(el, {dragmode:'eraseshape'});
    });
});

// Enhanced scroll wheel zoom on chart
(function setupAxisScrollZoom() {
    const checkChart = setInterval(() => {
        if (!el || !el._fullLayout) return;
        clearInterval(checkChart);
        
        const plotDiv = el;
        
        // Add wheel event listener with capture phase to intercept before Plotly
        plotDiv.addEventListener('wheel', (e) => {
            const target = e.target;
            
            // Check if scrolling on X-axis labels
            const onXAxis = target.closest('.xaxislayer-above') || 
                           target.closest('.xtick') ||
                           (target.classList && (target.classList.contains('xtick') || 
                                                target.classList.contains('xaxislayer-above')));
            
            // Check if scrolling on Y-axis labels
            const onYAxis = target.closest('.yaxislayer-above') || 
                           target.closest('.ytick') ||
                           (target.classList && (target.classList.contains('ytick') || 
                                                target.classList.contains('yaxislayer-above')));
            
            // Check if scrolling on plot area (the actual chart)
            const onPlotArea = target.closest('.nsewdrag') || 
                              target.closest('.xy') ||
                              target.closest('.plot') ||
                              (target.classList && (target.classList.contains('nsewdrag') || 
                                                   target.classList.contains('xy') ||
                                                   target.classList.contains('plot')));
            
            // Only handle if on axis labels OR plot area
            if (!onXAxis && !onYAxis && !onPlotArea) return;
            
            // Always prevent default and stop propagation to ensure zoom works
            e.preventDefault();
            e.stopPropagation();
            
            const zoomFactor = e.deltaY > 0 ? 1.15 : 0.85; // Zoom out or in
            const layout = plotDiv._fullLayout;
            
            // Determine zoom direction
            let zoomXAxis = false;
            let zoomYAxis = false;
            
            if (onXAxis) {
                // Scrolling on X-axis labels: zoom X-axis only
                zoomXAxis = true;
            } else if (onYAxis) {
                // Scrolling on Y-axis labels: zoom Y-axis only
                zoomYAxis = true;
            } else if (onPlotArea) {
                // Scrolling on plot area
                if (e.shiftKey) {
                    // Shift + scroll: zoom X-axis (time/horizontal)
                    zoomXAxis = true;
                } else {
                    // Normal scroll: zoom Y-axis (price/vertical)
                    zoomYAxis = true;
                }
            }
            
            const updates = {};
            
            if (zoomXAxis) {
                // Zoom X-axis around center
                const xaxis = layout.xaxis;
                const currentRange = xaxis.range;
                if (!currentRange || currentRange.length !== 2) return;
                
                const x0 = new Date(currentRange[0]).getTime();
                const x1 = new Date(currentRange[1]).getTime();
                const center = (x0 + x1) / 2;
                const span = (x1 - x0) / 2;
                const newSpan = span * zoomFactor;
                
                updates['xaxis.range'] = [
                    new Date(center - newSpan),
                    new Date(center + newSpan)
                ];
                updates['xaxis.autorange'] = false;
            }
            
            if (zoomYAxis) {
                // Zoom Y-axis around center
                const yaxis = layout.yaxis;
                const currentRange = yaxis.range;
                if (!currentRange || currentRange.length !== 2) return;
                
                const y0 = currentRange[0];
                const y1 = currentRange[1];
                const center = (y0 + y1) / 2;
                const span = (y1 - y0) / 2;
                const newSpan = span * zoomFactor;
                
                updates['yaxis.range'] = [center - newSpan, center + newSpan];
                updates['yaxis.autorange'] = false;
            }
            
            if (Object.keys(updates).length > 0) {
                Plotly.relayout(plotDiv, updates);
            }
        }, { passive: false, capture: true }); // Use capture phase to intercept early
        
    }, 100);
})();

// Form submission handler to copy symbol value to hidden field
document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    const symbolInput = document.getElementById('symbol-input');
    const symbolHidden = document.getElementById('symbol-hidden');
    
    if (form && symbolInput && symbolHidden) {
        form.addEventListener('submit', () => {
            symbolHidden.value = symbolInput.value;
        });
    }
});

// ====== Overlays: EM band and scenario zones with labels ======
function currentXRange(){
    const r = el.layout?.xaxis?.range;
    if (r && r.length===2) return [new Date(r[0]), new Date(r[1])];
    const xs = chartData?.t || [];
    if (xs.length) return [new Date(xs[0]), new Date(xs[xs.length-1])];
    const now = new Date(); return [new Date(now-7*24*3600*1000), now];
}

async function _clearByTag(prefix){
    if (!el || !el._fullLayout) {
        console.warn('_clearByTag: chart element or layout not available');
        return;
    }
    // Get current shapes and annotations, filtering out those with matching tag prefix
    // Read from Plotly's current layout state
    const layout = el._fullLayout;
    if (!layout) {
        console.warn('_clearByTag: layout not available');
        return;
    }
    
    const currentShapes = (layout.shapes || []).slice(); // Make a copy to avoid mutation issues
    const currentAnnots = (layout.annotations || []).slice(); // Make a copy
    
    // Filter out shapes and annotations that match the prefix
    const shapes = currentShapes.filter(s => {
        const tag = s._generated_by;
        if (!tag || typeof tag !== 'string') return true; // Keep if no tag
        return !tag.startsWith(prefix); // Keep if tag doesn't start with prefix
    });
    
    const annots = currentAnnots.filter(a => {
        const tag = a._generated_by;
        if (!tag || typeof tag !== 'string') return true; // Keep if no tag
        return !tag.startsWith(prefix); // Keep if tag doesn't start with prefix
    });
    
    // Debug logging
    const removedShapes = currentShapes.length - shapes.length;
    const removedAnnots = currentAnnots.length - annots.length;
    if (removedShapes > 0 || removedAnnots > 0) {
        console.log(`_clearByTag('${prefix}'): Removing ${removedShapes} shapes, ${removedAnnots} annotations`);
    }
    
    // Update the layout with filtered arrays - this will remove all shapes/annotations with matching tags
    try {
        await Plotly.relayout(el, { shapes, annotations: annots });
        // Verify removal after Plotly updates
        await new Promise(resolve => setTimeout(resolve, 100));
        const verifyLayout = el._fullLayout;
        const remaining = (verifyLayout.shapes || []).filter(s => 
            s._generated_by && typeof s._generated_by === 'string' && s._generated_by.startsWith(prefix)
        ).length;
        if (remaining > 0) {
            console.warn(`_clearByTag: ${remaining} shapes with prefix '${prefix}' still remain after relayout`);
        }
    } catch (err) {
        console.error('Error clearing shapes/annotations:', err);
    }
}

async function showEMBand(em){
    if (!el || !el._fullLayout || !em) return;
    const [x0, x1] = currentXRange();
    const tag = 'em_band';
    await _clearByTag(tag);
    // Wait a moment for Plotly to update layout after clearing
    await new Promise(resolve => setTimeout(resolve, 50));
    const addShapes = [{
        type:'rect', xref:'x', yref:'y', x0:x0, x1:x1, y0: em.lower, y1: em.upper,
        fillcolor:'rgba(52,152,219,0.12)', line:{width:0}, layer:'below', _generated_by:tag
    }];
    // Read current shapes after clearing is complete
    const currentShapes = el._fullLayout?.shapes || [];
    await Plotly.relayout(el, { shapes: currentShapes.concat(addShapes) });
}
async function clearEMBand(){ 
    await _clearByTag('em_band'); 
}

// Track scenario shapes/annotations by using a marker property Plotly preserves
const SCENARIO_MARKER = '__scenario_zone__';

async function clearScenarioZones(){ 
    if (!el || !el._fullLayout) {
        console.warn('clearScenarioZones: chart not available');
        return;
    }
    
    const layout = el._fullLayout;
    const currentShapes = (layout.shapes || []).slice();
    const currentAnnots = (layout.annotations || []).slice();
    
    // Filter by checking both _generated_by and a visible property pattern (fillcolor for rects, specific colors for lines)
    const scenarioFillColors = ['rgba(46,204,113,0.18)', 'rgba(231,76,60,0.18)']; // bull/bear fills
    const scenarioLineColors = ['rgba(39,174,96,0.9)', 'rgba(192,57,43,0.9)']; // bull/bear lines
    
    const shapes = currentShapes.filter(s => {
        // Check _generated_by tag first
        const tag = s._generated_by;
        if (tag && typeof tag === 'string' && tag.startsWith('scenario_')) {
            return false; // Remove it
        }
        // Also check by visible properties (Plotly preserves these)
        if (s.type === 'rect' && s.fillcolor && scenarioFillColors.includes(s.fillcolor)) {
            return false; // Remove scenario rects
        }
        if (s.type === 'line' && s.line && scenarioLineColors.includes(s.line.color)) {
            return false; // Remove scenario lines
        }
        return true; // Keep everything else
    });
    
    const annots = currentAnnots.filter(a => {
        // Check _generated_by tag
        const tag = a._generated_by;
        if (tag && typeof tag === 'string' && tag.startsWith('scenario_')) {
            return false; // Remove it
        }
        // Also check by visible properties (bgcolor matches scenario line colors)
        if (a.bgcolor && (scenarioLineColors.includes(a.bgcolor) || 
            ['rgba(39,174,96,0.9)', 'rgba(192,57,43,0.9)'].some(c => a.bgcolor.includes(c.slice(5, -1))))) {
            return false; // Remove scenario annotations
        }
        return true; // Keep everything else
    });
    
    const removed = (currentShapes.length + currentAnnots.length) - (shapes.length + annots.length);
    if (removed > 0) {
        console.log(`clearScenarioZones: Removing ${removed} items`);
    }
    
    try {
        await Plotly.relayout(el, { shapes, annotations: annots });
        console.log('clearScenarioZones: Completed successfully');
    } catch (err) {
        console.error('Error clearing scenario zones:', err);
    }
}

async function showScenarioZones({direction, entry0, entry1, stop, t1, t2, t3}){
    if (!el || !el._fullLayout) return;
    const [x0, x1] = currentXRange();
    const fill = direction==='bull' ? 'rgba(46,204,113,0.18)' : 'rgba(231,76,60,0.18)';
    const line = direction==='bull' ? 'rgba(39,174,96,0.9)'  : 'rgba(192,57,43,0.9)';
    const tag  = `scenario_${direction}`;
    
    // Clear existing scenario zones first
    await clearScenarioZones();
    // Wait for Plotly to update
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const addShapes = [
        { type:'rect', xref:'x', yref:'y', x0:x0, x1:x1, y0: Math.min(entry0,entry1), y1: Math.max(entry0,entry1),
          fillcolor:fill, line:{width:0}, layer:'below', _generated_by:tag, name:SCENARIO_MARKER },
        { type:'line', xref:'x', yref:'y', x0:x0, x1:x1, y0: stop, y1: stop,
          line:{color:line, width:2}, _generated_by:tag, name:SCENARIO_MARKER }
    ];
    [t1,t2,t3].filter(Number.isFinite).forEach(ty=>{
        addShapes.push({ type:'line', xref:'x', yref:'y', x0:x0, x1:x1, y0:ty, y1:ty, 
          line:{color:line, width:1, dash:'dot'}, _generated_by:tag, name:SCENARIO_MARKER });
    });
    const rightX = x1;
    const addAnnots = [
        { x:rightX, y:stop, xref:'x', yref:'y', xanchor:'left', yanchor:'middle', text:'Stop', showarrow:false,
          font:{size:10, color:'#fff'}, bgcolor:line, bordercolor:line, opacity:0.95, _generated_by:tag, name:SCENARIO_MARKER }
    ];
    [['T1',t1],['T2',t2],['T3',t3]].forEach(([label,val])=>{
        if(!Number.isFinite(val)) return;
        addAnnots.push({ x:rightX, y:val, xref:'x', yref:'y', xanchor:'left', yanchor:'middle', text:label, showarrow:false,
            font:{size:10, color:'#fff'}, bgcolor:line, bordercolor:line, opacity:0.9, _generated_by:tag, name:SCENARIO_MARKER });
    });
    // Read current shapes/annotations after clearing is complete
    const currentShapes = el._fullLayout?.shapes || [];
    const currentAnnots = el._fullLayout?.annotations || [];
    const shapes = currentShapes.concat(addShapes);
    const annotations = currentAnnots.concat(addAnnots);
    await Plotly.relayout(el, { shapes, annotations });
}
</script>
{% endblock %}
